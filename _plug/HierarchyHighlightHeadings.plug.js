function u(t){let e=atob(t),n=e.length,r=new Uint8Array(n);for(let o=0;o<n;o++)r[o]=e.charCodeAt(o);return r}function c(t){typeof t=="string"&&(t=new TextEncoder().encode(t));let e="",n=t.byteLength;for(let r=0;r<n;r++)e+=String.fromCharCode(t[r]);return btoa(e)}var l=class{constructor(e="",n=1e3){this.prefix=e;this.maxCaptureSize=n;this.prefix=e,this.originalConsole={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),debug:console.debug.bind(console)},this.patchConsole()}originalConsole;logBuffer=[];patchConsole(){let e=n=>(...r)=>{let o=this.prefix?[this.prefix,...r]:r;this.originalConsole[n](...o),this.captureLog(n,r)};console.log=e("log"),console.info=e("info"),console.warn=e("warn"),console.error=e("error"),console.debug=e("debug")}captureLog(e,n){let r={level:e,timestamp:Date.now(),message:n.map(o=>{if(typeof o=="string")return o;try{return JSON.stringify(o)}catch{return String(o)}}).join(" ")};this.logBuffer.push(r),this.logBuffer.length>this.maxCaptureSize&&this.logBuffer.shift()}async postToServer(e,n){if(this.logBuffer.length>0){let o=[...this.logBuffer];this.logBuffer=[];try{if(!(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o.map(s=>({...s,source:n})))})).ok)throw new Error("Failed to post logs to server")}catch(i){console.warn("Could not post logs to server",i.message),this.logBuffer.unshift(...o)}}}},p;function y(t=""){return p=new l(t),p}var a=t=>{throw new Error("Not initialized yet")},f=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var d=new Map,g=0;f&&(globalThis.syscall=async(t,...e)=>await new Promise((n,r)=>{g++,d.set(g,{resolve:n,reject:r}),a({type:"sys",id:g,name:t,args:e})}));function h(t,e,n){f&&(a=n,self.addEventListener("message",r=>{(async()=>{let o=r.data;switch(o.type){case"inv":{let i=t[o.name];if(!i)throw new Error(`Function not loaded: ${o.name}`);try{let s=await Promise.resolve(i(...o.args||[]));a({type:"invr",id:o.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",o.name,"error:",s.message),a({type:"invr",id:o.id,error:s.message})}}break;case"sysr":{let i=o.id,s=d.get(i);if(!s)throw Error("Invalid request id");d.delete(i),o.error?s.reject(new Error(o.error)):s.resolve(o.result)}break}})().catch(console.error)}),a({type:"manifest",manifest:e}),y(`[${e.name} plug]`))}async function w(t,e){if(typeof t!="string"){let n=new Uint8Array(await t.arrayBuffer()),r=n.length>0?c(n):void 0;e={method:t.method,headers:Object.fromEntries(t.headers.entries()),base64Body:r},t=t.url}return syscall("sandboxFetch.fetch",t,e)}globalThis.nativeFetch=globalThis.fetch;function x(){globalThis.fetch=async function(t,e){let n=e&&e.body?c(new Uint8Array(await new Response(e.body).arrayBuffer())):void 0,r=await w(t,e&&{method:e.method,headers:e.headers,base64Body:n});return new Response(r.base64Body?u(r.base64Body):null,{status:r.status,headers:r.headers})}}f&&x();var m={},b={name:"HierarchyHighlightHeadings",assets:{},functions:{}},L={manifest:b,functionMapping:m};h(m,b,self.postMessage);export{L as plug};
