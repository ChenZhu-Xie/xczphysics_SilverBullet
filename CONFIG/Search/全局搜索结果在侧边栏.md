
# Global Search

## Virtual Page Ver 2

```space-lua
-- ============================================
-- Configuration
-- ============================================
local config = {
    showParentHeaders = false  -- Set to false to hide parent directory headers
}

-- Escape Lua pattern special characters (fixed version)
local function escapeLuaPattern(s)
    -- Lua pattern magic characters: ^ $ ( ) % . [ ] * + - ?
    -- Each must be escaped with % prefix
    local result = s
    result = string.gsub(result, "%%", "%%%%")  -- Must escape % first
    result = string.gsub(result, "%^", "%%^")
    result = string.gsub(result, "%$", "%%$")
    result = string.gsub(result, "%(", "%%(")
    result = string.gsub(result, "%)", "%%)")
    result = string.gsub(result, "%.", "%%.")   -- This fixes virtualPage.
    result = string.gsub(result, "%[", "%%[")
    result = string.gsub(result, "%]", "%%]")
    result = string.gsub(result, "%*", "%%*")
    result = string.gsub(result, "%+", "%%+")
    result = string.gsub(result, "%-", "%%-")
    result = string.gsub(result, "%?", "%%?")
    return result
end

-- local function escapeLuaPattern(s)
--     return string.gsub(s, "[%^%$%(%)%%%.%[%]%*%+%-%?]", "%%%1")
-- end

-- Clean context string (remove newlines, truncate)
local function cleanContext(s, maxLen)
    if not s then return "" end
    local cleaned = string.gsub(s, "[\r\n]+", " ")
    if maxLen and #cleaned > maxLen then
        cleaned = string.sub(cleaned, 1, maxLen) .. "â€¦"
    end
    return cleaned
end

-- Get directory depth of a page path
local function getDepth(pageName)
    local depth = 1
    for _ in string.gmatch(pageName, "/") do
        depth = depth + 1
    end
    return depth
end

-- Generate heading prefix based on depth
local function headingPrefix(depth)
    if depth > 6 then depth = 6 end
    return string.rep("#", depth) .. " "
end

-- Build hierarchical headers for a page path
local function buildHierarchicalHeaders(pageName, existingPaths)
    local output = {}
    local parts = {}
    for part in string.gmatch(pageName, "[^/]+") do
        table.insert(parts, part)
    end
    
    local currentPath = ""
    for i, part in ipairs(parts) do
        if i > 1 then
            currentPath = currentPath .. "/"
        end
        currentPath = currentPath .. part
        
        if not existingPaths[currentPath] then
            existingPaths[currentPath] = true
            if i == #parts then
                -- Always show the final page link
                table.insert(output, headingPrefix(i) .. "[[" .. pageName .. "]]")
            elseif config.showParentHeaders then
                -- Only show parent headers if config allows
                table.insert(output, headingPrefix(i) .. part)
            end
        end
    end
    
    return output
end

-- Core search function
local function searchGlobalOptimized(keyword)
    if not keyword or keyword == "" then
        return nil, 0, 0
    end
    
    local results = {}
    local matchCount = 0
    local pageCount = 0
    
    local escapedKeyword = escapeLuaPattern(keyword)
    local pattern = "(.{0,15})" .. escapedKeyword .. "(.{0,15})"
    
    local pages = space.listPages()
    local existingPaths = {}
    
    for _, page in ipairs(pages) do
        if not string.find(page.name, "^search:") then
            local content = space.readPage(page.name)
            
            if content and string.find(content, keyword, 1, true) then
                local pageMatches = {}
                local matchIndex = 0
                
                for prefix, suffix in string.gmatch(content, pattern) do
                    local cleanPrefix = cleanContext(prefix, 15)
                    local cleanSuffix = cleanContext(suffix, 15)
                    matchIndex = matchIndex + 1
                    
                    local formatted = string.format(
                        "%d. â€¦%s==%s==%sâ€¦",
                        matchIndex,
                        cleanPrefix,
                        keyword,
                        cleanSuffix
                    )
                    table.insert(pageMatches, formatted)
                    matchCount = matchCount + 1
                end
                
                if #pageMatches > 0 then
                    pageCount = pageCount + 1
                    local headers = buildHierarchicalHeaders(page.name, existingPaths)
                    for _, header in ipairs(headers) do
                        table.insert(results, header)
                    end
                    for _, match in ipairs(pageMatches) do
                        table.insert(results, match)
                    end
                    table.insert(results, "")
                end
            end
        end
    end
    
    return results, matchCount, pageCount
end

-- Virtual Page: search:keyword
virtualPage.define {
    pattern = "search:(.+)",
    run = function(keyword)
        keyword = keyword:trim()
        
        if not keyword or keyword == "" then
            return [[
# âš ï¸ Search Error
Please provide a search keyword.
**Usage:** Navigate to `search:your_keyword` or use command `Global Search`
]]
        end
        
        local results, matchCount, pageCount = searchGlobalOptimized(keyword)
        local output = {}
        
        table.insert(output, "# ðŸ” Search Results")
        table.insert(output, string.format(
            "> **Keyword:** ==`%s`== | **Matches:** %d | **Pages:** %d",
            keyword, matchCount, pageCount
        ))
        
        if matchCount == 0 then
            table.insert(output, "")
            table.insert(output, "ðŸ˜” **No results found**")
            table.insert(output, "")
            table.insert(output, "Suggestions:")
            table.insert(output, "1. Check spelling")
            table.insert(output, "2. Try shorter or more general keywords")
            table.insert(output, "3. Keywords are case-sensitive")
        else
            table.insert(output, "")
            for _, line in ipairs(results) do
                table.insert(output, line)
            end
        end
        
        return table.concat(output, "\n")
    end
}

-- Command: Global Search
command.define {
    name = "Global Search",
    run = function()
        local keyword = editor.prompt("ðŸ” Global Search", "")
        if keyword and keyword:trim() ~= "" then
            editor.navigate("search:" .. keyword:trim())
        end
    end,
    key = "Ctrl-Shift-f",
    mac = "Cmd-Shift-f",
    priority = 1,
}
```

## Virtual Page Ver 1

```lua
-- priority: 11

-- ============================================
-- å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰ Lua æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
-- ============================================
-- Escape Lua pattern special characters
local function escapeLuaPattern(s)
    local matches = {
        ["^"] = "%^", ["$"] = "%$", ["("] = "%(", [")"] = "%)",
        ["%"] = "%%", ["."] = "%." , ["["] = "%[", ["]"] = "%]",
        ["*"] = "%*", ["+"] = "%+", ["-"] = "%-", ["?"] = "%?"
    }
    return string.gsub(s, ".", matches)
end

-- ============================================
-- å·¥å…·å‡½æ•°ï¼šæ¸…ç†å­—ç¬¦ä¸²ï¼ˆåŽ»é™¤é¦–å°¾ç©ºç™½ã€æ›¿æ¢æ¢è¡Œç¬¦ï¼‰
-- ============================================
local function cleanContext(s, maxLen)
    if not s then return "" end
    -- æ›¿æ¢æ¢è¡Œä¸ºç©ºæ ¼ï¼Œé¿å…ç ´ååˆ—è¡¨æ ¼å¼
    local cleaned = string.gsub(s, "[\r\n]+", " ")
    -- æˆªæ–­è¿‡é•¿å†…å®¹
    if maxLen and #cleaned > maxLen then
        cleaned = string.sub(cleaned, 1, maxLen) .. "â€¦"
    end
    return cleaned
end

-- ============================================
-- æ ¸å¿ƒæœç´¢å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
-- ============================================
local function searchGlobalOptimized(keyword)
    if not keyword or keyword == "" then
        return nil, 0
    end
    
    local output = {}
    local matchCount = 0
    local pageCount = 0
    
    -- é¢„ç¼–è¯‘ patternï¼ˆLua å®žé™…ä¸Šæ¯æ¬¡ gmatch éƒ½ç¼–è¯‘ï¼Œä½†è¿™é‡Œç»Ÿä¸€å®šä¹‰ï¼‰
    local escapedKeyword = escapeLuaPattern(keyword)
    -- æ•èŽ· keyword å‰åŽå„ 15 ä¸ªå­—ç¬¦ä½œä¸ºä¸Šä¸‹æ–‡
    local pattern = "(.{0,15})" .. escapedKeyword .. "(.{0,15})"
    
    local pages = space.listPages()
    
    for _, page in ipairs(pages) do
        -- è·³è¿‡æœç´¢ç»“æžœé¡µæœ¬èº«ï¼Œé˜²æ­¢æ­»å¾ªçŽ¯
        if not string.find(page.name, "^search:") then
            local content = space.readPage(page.name)
            
            if content then
                -- [æ ¸å¿ƒä¼˜åŒ–] å…ˆç”¨ plain string search å¿«é€Ÿæ£€æŸ¥
                -- string.find çš„ç¬¬4ä¸ªå‚æ•° true è¡¨ç¤ºçº¯æ–‡æœ¬åŒ¹é…ï¼Œä¸è§£é‡Š pattern
                if string.find(content, keyword, 1, true) then
                    local pageMatches = {}
                    
                    -- åªæœ‰ç¡®è®¤åŒ…å«å…³é”®è¯åŽï¼Œæ‰æ‰§è¡Œæ˜‚è´µçš„æ­£åˆ™æå–
                    for prefix, suffix in string.gmatch(content, pattern) do
                        local cleanPrefix = cleanContext(prefix, 15)
                        local cleanSuffix = cleanContext(suffix, 15)
                        
                        -- ä½¿ç”¨ SilverBullet çš„é«˜äº®è¯­æ³• ==keyword==
                        local formatted = string.format(
                            "* â€¦%s==%s==%sâ€¦",
                            cleanPrefix,
                            keyword,
                            cleanSuffix
                        )
                        table.insert(pageMatches, formatted)
                        matchCount = matchCount + 1
                    end
                    
                    -- åªæœ‰æœ‰åŒ¹é…æ—¶æ‰è¾“å‡ºè¯¥é¡µé¢
                    if #pageMatches > 0 then
                        pageCount = pageCount + 1
                        -- é¡µé¢æ ‡é¢˜ï¼ˆå¯ç‚¹å‡»çš„ wiki linkï¼‰
                        table.insert(output, "### [[" .. page.name .. "]]")
                        -- è¯¥é¡µé¢çš„æ‰€æœ‰åŒ¹é…é¡¹
                        for _, match in ipairs(pageMatches) do
                            table.insert(output, match)
                        end
                        -- é¡µé¢ä¹‹é—´çš„ç©ºè¡Œåˆ†éš”
                        table.insert(output, "")
                    end
                end
            end
        end
    end
    
    return output, matchCount, pageCount
end

-- ============================================
-- å®šä¹‰ Virtual Pageï¼šsearch:å…³é”®è¯
-- ============================================
virtualPage.define {
    pattern = "search:(.+)",
    run = function(keyword)
        -- æ¸…ç†å…³é”®è¯
        keyword = keyword:trim()
        
        if not keyword or keyword == "" then
            return [[
# âš ï¸ æœç´¢é”™è¯¯

è¯·æä¾›æœç´¢å…³é”®è¯ã€‚

**ç”¨æ³•ï¼š** å¯¼èˆªåˆ° `search:ä½ çš„å…³é”®è¯` æˆ–ä½¿ç”¨å‘½ä»¤ `Global Search`
]]
        end
        
        -- æ‰§è¡Œæœç´¢
        local results, matchCount, pageCount = searchGlobalOptimized(keyword)
        
        -- æž„å»ºè¾“å‡º
        local output = {}
        
        -- å¤´éƒ¨ä¿¡æ¯
        table.insert(output, "# ðŸ” æœç´¢ç»“æžœ")
        table.insert(output, "")
        table.insert(output, string.format(
            "> **å…³é”®è¯ï¼š** `%s` | **åŒ¹é…ï¼š** %d å¤„ | **é¡µé¢ï¼š** %d ä¸ª",
            keyword, matchCount, pageCount
        ))
        table.insert(output, "")
        
        if matchCount == 0 then
            table.insert(output, "---")
            table.insert(output, "")
            table.insert(output, "ðŸ˜” **æœªæ‰¾åˆ°åŒ¹é…ç»“æžœ**")
            table.insert(output, "")
            table.insert(output, "å»ºè®®ï¼š")
            table.insert(output, "* æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®")
            table.insert(output, "* å°è¯•ä½¿ç”¨æ›´çŸ­æˆ–æ›´é€šç”¨çš„å…³é”®è¯")
            table.insert(output, "* å…³é”®è¯åŒºåˆ†å¤§å°å†™")
        else
            table.insert(output, "---")
            table.insert(output, "")
            -- åˆå¹¶æœç´¢ç»“æžœ
            for _, line in ipairs(results) do
                table.insert(output, line)
            end
        end
        
        -- ä½¿ç”¨ table.concat é«˜æ•ˆæ‹¼æŽ¥ï¼ˆæ¯” .. è¿žæŽ¥é«˜æ•ˆå¾—å¤šï¼‰
        return table.concat(output, "\n\n")
    end
}

-- ============================================
-- å®šä¹‰å‘½ä»¤ï¼šå”¤èµ·å…¨å±€æœç´¢
-- ============================================
command.define {
    name = "Global Search",
    run = function()
        local keyword = editor.prompt("ðŸ” å…¨å±€æœç´¢", "è¾“å…¥å…³é”®è¯...")
        if keyword and keyword:trim() ~= "" then
            -- ç›´æŽ¥å¯¼èˆªåˆ° virtual pageï¼Œç”± SilverBullet åŽŸç”Ÿæ¸²æŸ“
            editor.navigate("search:" .. keyword:trim())
        end
    end,
    key = "Ctrl-Alt-f",
    mac = "Cmd-Alt-f",
    priority = 1,
}

command.define {
    name = "Close Search Panel",
    run = function()
        editor.hidePanel('rhs')
    end
}
```

## Old Ver

1. https://community.silverbullet.md/t/fixing-silver-bullets-chinese-search-gap-a-space-lua-global-search-implementation/3157

```lua
-- Escape regular expression special characters in keywords
local function escapeKeyword(keyword)
    -- List of regular expression special characters: . ^ $ * + ? ( ) [ ] { } | \
    local specialChars = {
        ["."] = "%.",
        ["^"] = "%^",
        ["$"] = "%$",
        ["*"] = "%*",
        ["+"] = "%+",
        ["?"] = "%?",
        ["("] = "%(",
        [")"] = "%)",
        ["["] = "%[",
        ["]"] = "%]",
        ["{"] = "%{",
        ["}"] = "%}",
        ["|"] = "%|",
        ["\\"] = "\\\\"
    }
    -- Replace special characters in the keyword with their escaped versions
    return string.gsub(keyword, ".", function(char)
        return specialChars[char] or char
    end)
end

-- Extract 10 characters before and after the keyword (handles cases with fewer than 10 characters)
-- Parameters: content (content to search), keyword (keyword to search for)
-- Returns: Iterator (each iteration returns a match result in the format: prefix + keyword + suffix)
local function extractKeywordContext(content, keyword)
    -- 1. Escape the keyword (handle special characters)
    local escapedKeyword = escapeKeyword(keyword)
    -- 2. Build regular expression pattern (0-10 characters before + keyword + 0-10 characters after)
    local pattern = ".{0,10}" .. escapedKeyword .. ".{0,10}"
    -- 3. Use string.gmatch to iterate through matches and concatenate results
    return string.gmatch(content, pattern)
end

local function searchGlobal(keyword)
    local result = ""
    local pages = space.listPages()
    for i, page in ipairs(pages) do
        local matchs = ""
        local content = space.readPage(page.name)
        for match in extractKeywordContext(content, keyword) do
            matchs = matchs .. "* " .. match .. '\n'
        end
        if #matchs > 0 then
            result = result .. "## [[" .. page.name .. "]]\n" .. matchs
        end
    end
    return result
end

command.define {
  name = "Global Search",
  run = function()
    -- local keyword = editor.prompt("Keyword","")
    local keyword = usrPrompt(Keyword, "")
    if keyword and #keyword > 0 then
      local res = searchGlobal(keyword)
      if #res > 0 then
        editor.showPanel('rhs', 1, markdown.markdownToHtml(res))
      else
        editor.flashNotification('not found', 'warn')
      end
    end
  end,
  key = "Ctrl-Alt-f",
  mac = "Cmd-Alt-f",
  priority = 1,
}

command.define {
  name = "close Global Search",
  run = function()
    editor.hidePanel('rhs')
  end
}
```
