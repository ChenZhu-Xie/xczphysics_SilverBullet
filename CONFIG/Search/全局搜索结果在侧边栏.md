
1. https://community.silverbullet.md/t/fixing-silver-bullets-chinese-search-gap-a-space-lua-global-search-implementation/3157

```space-lua
-- Escape regular expression special characters in keywords
local function escapeKeyword(keyword)
    -- List of regular expression special characters: . ^ $ * + ? ( ) [ ] { } | \
    local specialChars = {
        ["."] = "%.",
        ["^"] = "%^",
        ["$"] = "%$",
        ["*"] = "%*",
        ["+"] = "%+",
        ["?"] = "%?",
        ["("] = "%(",
        [")"] = "%)",
        ["["] = "%[",
        ["]"] = "%]",
        ["{"] = "%{",
        ["}"] = "%}",
        ["|"] = "%|",
        ["\\"] = "\\\\"
    }
    -- Replace special characters in the keyword with their escaped versions
    return string.gsub(keyword, ".", function(char)
        return specialChars[char] or char
    end)
end

-- Extract 10 characters before and after the keyword (handles cases with fewer than 10 characters)
-- Parameters: content (content to search), keyword (keyword to search for)
-- Returns: Iterator (each iteration returns a match result in the format: prefix + keyword + suffix)
local function extractKeywordContext(content, keyword)
    -- 1. Escape the keyword (handle special characters)
    local escapedKeyword = escapeKeyword(keyword)
    -- 2. Build regular expression pattern (0-10 characters before + keyword + 0-10 characters after)
    local pattern = ".{0,10}" .. escapedKeyword .. ".{0,10}"
    -- 3. Use string.gmatch to iterate through matches and concatenate results
    return string.gmatch(content, pattern)
end

local function searchGlobal(keyword)
    local result = ""
    local pages = space.listPages()
    for i, page in ipairs(pages) do
        local matchs = ""
        local content = space.readPage(page.name)
        for match in extractKeywordContext(content, keyword) do
            -- 这里对 match 进行 HTML 转义是个好习惯，防止内容里的 < > 破坏显示
            match = string.gsub(match, "<", "&lt;")
            match = string.gsub(match, ">", "&gt;")
            matchs = matchs .. "* " .. match .. '\n'
        end
        
        if #matchs > 0 then
            -- 【关键修改】
            -- 1. 处理文件名中的单引号，防止破坏 JS 字符串
            local safePageName = string.gsub(page.name, "'", "\\'")
            
            -- 2. 构建 HTML 链接
            -- onclick 事件做了两件事：
            --    a. syscall('editor.navigate', ...): 通知编辑器跳转
            --    b. syscall('editor.hidePanel', 'rhs'): 跳转后自动关闭搜索面板（可选，体验更好）
            local linkHtml = string.format(
                '<a href="#" onclick="event.preventDefault(); syscall(\'editor.navigate\', \'%s\'); syscall(\'editor.hidePanel\', \'rhs\');" style="cursor: pointer; text-decoration: underline;">%s</a>', 
                safePageName, 
                page.name
            )
            
            -- 3. 将 HTML 嵌入到 Markdown 的标题中
            result = result .. "## " .. linkHtml .. "\n" .. matchs
        end
    end
    return result
end


command.define {
  name = "Global Search",
  run = function()
    -- local keyword = editor.prompt("Keyword","")
    local keyword = usrPrompt(Keyword, "")
    if keyword and #keyword > 0 then
      local res = searchGlobal(keyword)
      if #res > 0 then
        editor.showPanel('rhs', 1, markdown.markdownToHtml(res))
      else
        editor.flashNotification('not found', 'warn')
      end
    end
  end,
  key = "Ctrl-Alt-f",
  mac = "Cmd-Alt-f",
  priority = 1,
}

command.define {
  name = "close Global Search",
  run = function()
    editor.hidePanel('rhs')
  end
}
```